services:
  # Download services
  deluge:
    image: linuxserver/deluge:latest
    restart: unless-stopped
    environment:
      - PUID=${PUID}
      - PGID=${PGID}
      - TZ=${TZ}
    volumes:
      - ${CONFIG}/deluge:/config
      - ${DOWNLOADS}:/downloads
  prowlarr:
    image: linuxserver/prowlarr:latest
    restart: unless-stopped
    environment:
      - PUID=${PUID}
      - PGID=${PGID}
      - TZ=${TZ}
      - UMASK=002
    volumes:
      - /etc/localtime:/etc/localtime:ro
      - ${CONFIG}/prowlarr:/config
  radarr:
    image: linuxserver/radarr:latest
    restart: unless-stopped
    environment:
      - PUID=${PUID}
      - PGID=${PGID}
      - TZ=${TZ}
    volumes:
      - /etc/localtime:/etc/localtime:ro
      - ${CONFIG}/radarr:/config
      - ${DOWNLOADS}:/downloads
      - ${MEDIA}/films:/films
    depends_on:
      - deluge
      - prowlarr
  sonarr:
    image: linuxserver/sonarr:latest
    restart: unless-stopped
    environment:
      - PUID=${PUID}
      - PGID=${PGID}
      - TZ=${TZ}
    volumes:
      - /etc/localtime:/etc/localtime:ro
      - ${CONFIG}/sonarr:/config
      - ${DOWNLOADS}:/downloads
      - ${MEDIA}/shows:/shows
    depends_on:
      - deluge
      - prowlarr

  # Dashboard
  dashy:
    image: lissy93/dashy:latest
    restart: unless-stopped
    environment:
      - NODE_ENV=production
      - UID=${PUID}
      - GID=${PGID}
    volumes:
      - ${CONFIG}/dashy/config.yml:/user-data/conf.yml
    ports:
      - 4000:8080
    healthcheck:
      test: ["CMD", "node", "/app/services/healthcheck"]
      interval: 1m30s
      timeout: 10s
      retries: 3
      start_period: 40s

  # Reverse proxy + Tailscale
  caddy:
    build: ${CONFIG}/caddy
    restart: unless-stopped
    cap_add:
      - NET_ADMIN
    environment:
      - TS_AUTHKEY=${TS_AUTHKEY}
      - DOMAIN=${DOMAIN:-}
      - CF_API_TOKEN=${CF_API_TOKEN:-}
    volumes:
      - ${CONFIG}/caddy/Caddyfile:/etc/caddy/Caddyfile
      - ${CONFIG}/caddy/data:/data
      - ${CONFIG}/caddy/config:/config

  # Media server
  jellyfin:
    image: linuxserver/jellyfin:latest
    restart: unless-stopped
    environment:
      - PUID=${PUID}
      - PGID=${PGID}
      - TZ=${TZ}
    volumes:
      - ${CONFIG}/jellyfin:/config
      - ${MEDIA}/films:/data/films
      - ${MEDIA}/shows:/data/shows
    ports:
      - 8096:8096

  # File management
  filebrowser:
    image: filebrowser/filebrowser:latest
    restart: unless-stopped
    environment:
      - PUID=${PUID}
      - PGID=${PGID}
    volumes:
      - ${CONFIG}:/srv/config
      - ${CONFIG}/filebrowser:/config
      - ${DOWNLOADS}:/srv/downloads
      - ${MEDIA}:/srv/media
    ports:
      - 8080:80

  # Container management
  portainer:
    image: portainer/portainer-ce:lts
    restart: unless-stopped
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock
      - ${CONFIG}/portainer:/data
    ports:
      - 9000:9000

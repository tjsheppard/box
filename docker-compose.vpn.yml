# VPN override - routes download services through Mullvad WireGuard
# Enable by adding to .env: COMPOSE_FILE=docker-compose.yml:docker-compose.vpn.yml

services:
  gluetun:
    image: qmcgaw/gluetun:latest
    restart: unless-stopped
    cap_add:
      - NET_ADMIN
    devices:
      - /dev/net/tun:/dev/net/tun
    ports:
      - 8112:8112 # deluge
      - 6881:6881 # deluge
      - 6881:6881/udp # deluge
      - 9696:9696 # prowlarr
      - 8989:8989 # sonarr
      - 7878:7878 # radarr
    environment:
      - VPN_SERVICE_PROVIDER=mullvad
      - VPN_TYPE=wireguard
      - WIREGUARD_PRIVATE_KEY=${WIREGUARD_PRIVATE_KEY}
      - WIREGUARD_ADDRESSES=${WIREGUARD_ADDRESSES}
      - SERVER_CITIES=${VPN_CITY}
      - FIREWALL_OUTBOUND_SUBNETS=192.168.1.0/24

  # Override download services to route through VPN
  deluge:
    network_mode: service:gluetun
    depends_on:
      - gluetun

  prowlarr:
    network_mode: service:gluetun
    depends_on:
      - gluetun

  radarr:
    network_mode: service:gluetun
    depends_on:
      - gluetun

  sonarr:
    network_mode: service:gluetun
    depends_on:
      - gluetun

  # Point Caddy at VPN container for download services
  caddy:
    environment:
      - DELUGE_ADDR=gluetun:8112
      - PROWLARR_ADDR=gluetun:9696
      - SONARR_ADDR=gluetun:8989
      - RADARR_ADDR=gluetun:7878
